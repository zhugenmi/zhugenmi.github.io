---
title: 数据库表间连接
author: zhugenmi
date: 2025-1-3 10:00 +0800
categories: [数据库原理与应用,SQL Server]
tags: [sqlserver]
description: 
---

# 连接的概念

何时要使用到多表操作

（1）嵌套查询可能用到。

如查出选了d01课程的学生数据：学号,姓名，性别。 这些数据来自于学生表，但要根据成绩表中查哪些选了D01课程的学生的学号，涉及了两个表操作。

```sql
Select 学号,姓名,性别 from 学生表 where 学号 in(select 学号 from 成绩表 where 课程号=’d01’)
```

SQL嵌套IN查询不能超过3层。

（2）数据查询结果（不是条件）来自于多个表。

如，查出选了D01课程的学生数据：学号，姓名，性别，课程号，成绩值。

第一种情况数据来源单一表学生表，虽然使用了成绩表，但结果没有成绩表的数据，成绩表的数据仅仅作为主查询的条件。可以使用连接也可以使用嵌套，把子查询的结果作为主查询的条件。此时，并非同时操作两个表，先操作的成绩表，把子查询结果列出为作常量集合（成绩表已经关闭），再打开学生表提取数据。虽然使用到了两个表，但是一前一后打开使用的.故，查询结果只能来自于学生表，不能出现成绩表的数据。

 第二种情况数据来源于成绩表和学生表同时提供，这两个是并列操作，必须使用连接.

## 连接的概念

在逻辑上把两个及以上的物理表或视图，在列向上合并（不是记录合并，是列属性集合合并）,在逻辑上把两个表的查询结果当成一个视图。

 连接时，一般需要两表关键字有对应关系，如上两个表都有学号列，否则可能结果是笛卡尔积。（如所有学生把所有课堂一个不漏地选一次）

如何修改？实现连接查询

```sql
Select 学生表.学号,姓名,性别,课程号,成绩 
  from 学生表,成绩表 where 学生表.学号=成绩表.学号 
```

两表按学号关键字对应匹配生成新记录。把学生表每个人按学号值去成绩表匹配相同学号，应对生成一个学生一门课数据。如果该生选了五门课，要匹配成功五次学号，结果中就该生的五条记录.

# 各种链接操作

## 内连接

 `` a inner join b`` 要求两表能对应的记录才出现的结果中，不对应的记录被忽略掉。如学生表中x同学没有选课，则他在成绩表中无记录，内连接查询时，结果无x同学数据。

上例其实是内连接的另一种早期的写法

```sql
 Select 学生表.学号,姓名,性别,课程号,成绩 
  from 学生表,成绩表 where 学生表.学号=成绩表.学号
```

标准化内连接:

```sql
Select 学生表.学号,姓名,性别,课程号,成绩 
  from 学生表 inner join 成绩表 
  on 学生表.学号=成绩表.学号
```

以前子句也可以使用

```sql
select a.学号,a.姓名,b.课程号,成绩 
 from 学生表 a inner join 成绩表 b on a.学号=b.学号
 where 课程号 in (101,102,103) order by 课程号
```

> a inner join b 可省写为:a join b 

例：查出选了大学英语的男生的数据情况：学号，课程号，成绩

使用两种方法实现：

方法1: 用嵌套

```sql
select 学号,课程号,成绩 from 成绩表 
 where 学号 in(select 学号 from 学生表 where 性别='男')
 and 课程号in(select 课程号 from 课程表 where 名称='大学英语')
```

方法2:使用表的连接实现

```sql
select 成绩表.学号,课程表.课程号,成绩 from 
  成绩表 inner join 学生表 on 成绩表.学号=学生表.学号
  inner join 课程表 on 成绩表.课程号=课程表.课程号
  where 性别='男' and 名称='大学英语'
```

三个表及以上如何实现内连接？

```sql
A inner join b on a.key1=b.key1
 inner join c on b.key2=c.key2
 inner join d on c.key3=d.key4
```

内连接时，表的左右位置无所谓

例：改写上例：查出选了大学英语的男生的数据情况：学号，姓名，性别，课程号，课程名称，成绩

查询结果来源于三个表都有数据

```sql
select 成绩表.学号,姓名,性别,课程表.课程号,名称,成绩 from 
  成绩表 inner join 学生表 on 成绩表.学号=学生表.学号
  inner join 课程表 on 成绩表.课程号=课程表.课程号
  where 性别='男' and 名称='大学英语'
```

## 外连接的左连接

`` a left join b ``，生成的结果以左表a为准，a表的所有记录都列出来,如果b中不存在a中的部分记录，即可能部分a中的记录在b中无对应，则b中的数据以空值代表。

 例：在上例基础上改为学生表左连接

```sql
select 学生表.学号,姓名,性别,课程号,成绩 from 
  学生表 left join 成绩表 on 成绩表.学号=学生表.学号
```

例：在上例基础上，改为：列出没有选课的学生数据

```sql
 Select * from 学生表 where 学号 not in(select distinct学号 from 成绩表 )
```

新办法：

```sql
select * from
  学生表 left join 成绩表 on 成绩表.学号=学生表.学号
  where 课程号 is NULL
```

## 外连接的右连接

 `a right join b` 与上同理，查询结果以右边b表数据为准，如果a表中无记录对应，则以null值代表

```sql
select * from
  学生表 left join 成绩表 on 成绩表.学号=学生表.学号
  where 课程号 is NULL
```

改为：

```sql
select * from 
  成绩表 right join 学生表 on 成绩表.学号=学生表.学号
  where 课程号 is NULL
```

## 全连接

`` a full join b ``：两个表的所有数据都要列出来，凡是对方表中无对应的记录，则都以Null值代表

`inner join` 是要求a,b两表记录条件相交， `full join` 要求a,b两表记录相并。

如有A,B,C三个表，连接查询时，AB之间以B数据为准，BC连接时以C为数据为准。

```sql
 …from a right join b on a.key1=b.key1
  right join c on b.key2=c.key2
```

## 自连接

一个表自己与自己连接，一个物理表被打开两次，冠以不同别名，当成两个独立的表使用。

```sql
 …from 表1 as a inner join 表1 as b on a.key=b.key
```

 例：从学生表中找到与李大方同性别的其它人。

方法1: 用嵌套 

```sql
 select 姓名,性别 from 学生表 where 性别=
(select 性别 from 学生表 where 姓名='李大方') and 姓名!='李大方'
```

方法2:用自连接

把学生表打开两次，内连接起来。其中一个表作为数据输出的表，另一个表作为条件限制的表。

```sql
select a.学号,a.姓名,a.性别 
 from 学生表 as a inner join 学生表 as b
 on a.性别=b.性别 
 where a.姓名!='李大方' and b.姓名='李大方'
```

例：查出101课程中，高于本101课程平均分有哪些同学，列出他们的学号和姓名。

```sql
Select 学号,姓名 from 学生表 where 学号 in ( 
 Select 学号 from 成绩表 where 成绩>(Select avg(成绩) from 成绩表 where 课程号=’101’) and 课程号=’101’)
```

例：从成绩表中查出考试平均成绩高于全体学生的总平均成绩的学生学号和平均分。

分析：这样理解：学生的考试平均成绩是该生所有几门选课中的平均成绩. 全体学生的总平均成绩是指某一科课程的所有学生的平均成绩.

```sql
select 学号,AVG(成绩) as 平均分 from 成绩表
 group by 学号
 having AVG(成绩)>(select AVG(成绩) from 成绩表)
```

# 存在性测试

使用子查询时，把子查询的结果作为主查询的条件。如果子查询的结果不存在咋办？

```sql
where [not] exists（子查询）
```

 例:查询选了101课程的学生的姓名

 方法1:  嵌套查询

```sql
 select 姓名 from 学生表 where 学号 in 
 (select 学号 from 成绩表 where 课程号='101')
```

方法2:存在性判断,接近于连接查询概念， 两表是同时存在的

```sql
 select 姓名 from 学生表 where exists
 (select 学号 from 成绩表 where 学号=学生表.学号 and 课程号='101') 
```

例：多种办法查出没有选101课程的学生的姓名和学号，性别。

方法1:多表连接实现查询

```sql
 select distinct a.学号,姓名,性别 from 学生表 a inner join   成绩表 b on a.学号=b.学号 where 课程号!='101'
```

方法2: 用嵌套子查询

```sql
select 学号,姓名,性别 from 学生表
 where 学号 in(select distinct 学号 from 成绩表 where 课程号!='101')
```

方法3: 用嵌套子查询2

 ```sql
select 学号,姓名,性别 from 学生表
 where 学号 not in(select distinct 学号 from 成绩表 where 课程号='101')
 ```

 注意：方法2和方法3结果不尽相同的. 如果每个学生保证至少选了一门课才时，上两方法才等效。

方法4:在子查询中使用存在性判断

```sql
select 学号,姓名,性别 from 学生表
 where exists(select * from 成绩表 where 学号=学生表.学号 and 课程号='101')
```

方法5:在主查询中存在性判断否定

```sql
select 学号,姓名,性别 from 学生表
 where not exists(select 学号 from 成绩表 where 学号=学生表.学号 and 课程号!='101')
```

 

