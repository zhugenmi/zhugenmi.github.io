---
title: Docker
author: zhugenmi
date: 2025-5-16 10:00 +0800
categories: [Systematic Capacity,TOOLS]
tags: [docker]
description: 
---
# Docker 基础

CNB 云原生开发环境中已经预装了 docker，无需学员手动安装，直接体验即可，可使用如下命令来查看 docker 信息

```shell
docker version  #查看版本信息
docker info     #查看运行时信息
```

## 运行你的第一个容器

```shell
docker run hello-world
```

跟所有的技术学习起点一样，上述命令使用 docker 运行一个最简单的 hello-world 容器，它的功能仅仅是在屏幕上打印一些文字。

`docker run` 首先会去本地寻找 hello-world 镜像，如果本地没有，则会从默认的 Docker 镜像仓库中拉去，也就是 [Docker Hub](https://cnb.cool/goto?url=https%3A%2F%2Fhub.docker.com%2F)。

镜像的格式一般为

```text
<repository>/<image>:<tag>
```

如果 repository 为空，默认为 Docker Hub, tag 为空，则默认为 latest， 如下是一个 CNB 制品库中的镜像示例, 其中 `repository` 为 docker.cnb.cool， `image` 为 looc/git-cnb，`tag` 为 latest。

```text
docker.cnb.cool/looc/git-cnb:latest
```

镜像分为 public 和 private 两种，对于 public 的镜像无需登录即可拉取，对于 private 的镜像则需要登录后才能拉取，登录命令如下

```shell
docker login <repository>
```

## 实践案例: 运行 Alpine Linux 容器

Alpine 镜像在企业生产环境中被广泛应用，它是一个极简的 Linux 发行版， 只包含最基本的命令和工具，因此镜像非常小，只有 5MB 左右，并且内置包管理系统 `apk`, 使其成为许多其他镜像的常用起点。

拉取镜像

```shell
docker pull alpine  #拉取镜像
docker image ls     #查看镜像
```

运行容器

```shell
docker run alpine ls -a  #运行容器
docker ps -a             #查看容器
```

交互式运行容器

docker run 命令默认使用镜像中的 Cmd 作为容器的启动命令，Cmd 可通过如下命令来查看。

```shell
docker inspect alpine --format='{{Config.Cmd}}'
```

可以看到默认的 Cmd 为 `["/bin/sh"]`，因此直接使用 `docker run alpine` 会启动 /bin/sh 这个 shell, 我们 期望可以在这个 shell 中执行一些命令，但实际上它只是启动了 shell，退出了 shell，然后就停止了容器。

```shell
docker run -it alpine  #等效于 docker run -it alpine /bin/sh, 使用 -it 参数启动容器进入交互式终端
```

后台运行容器

`run -it` 命令会启动一个交互式终端，退出终端后容器也会停止，如果希望容器在后台运行，可以使用 `-d` 参数，如下命令会启动一个后台运行的容器。

```shell
docker run -it -d alpine #后台运行容器
```

加上 -d 参数后，容器不会执行完命令后立即退出，而是会进入后台运行，此时会返回一个唯一的 ID，使用 `docker ps` 命令可以查看容器运行状态。

docker attach 用于连接到一个正在运行的容器，主要作用是 访问容器的主进程（PID=1）的标准输入输出流

```shell
docker attach <container_id>
```

由于 attach 是接管了 PID=1 的进程，因此如果这个进程是守护进程， 那么 attach 退出后，容器也会退出。所以一般不推荐使用 attach 命令。 而是使用 `docker exec` 命令来连接容器。

```shell
docker exec -it <container_id> /bin/sh
```

此时进入到容器中使用 `ps -a` 命令可以看到容器中存在两个进程，其中 PID=1 的进程为 /bin/sh， 而另一个 /bin/sh 进程则是我们通过 exec 命令启动的，这个进程退出不会影响 PID=1 的进程，也就不会导致容器的退出。

# **一、Docker vs Docker Compose 核心区别**

|  **对比项**  |          **Docker**          |             **Docker Compose**             |
| :----------: | :--------------------------: | :----------------------------------------: |
|   **定位**   | 容器运行时引擎（单容器管理） |       容器编排工具（多容器应用管理）       |
| **配置文件** | `Dockerfile`（定义镜像构建） |     `docker-compose.yml`（定义多服务）     |
| **典型命令** | `docker run`, `docker build` | `docker-compose up`, `docker-compose down` |
| **适用场景** | 单个容器部署（如运行Nginx）  |    多服务协同部署（如Web+DB+Redis组合）    |
| **网络管理** |   需手动创建网络并连接容器   |         自动为所有服务创建共享网络         |

------

# **二、Linux 安装步骤**

## **1. 安装 Docker Engine（所有Linux发行版通用）**

```bash
# 1. 卸载旧版本（如有）
sudo apt remove docker docker-engine docker.io containerd runc  # Ubuntu/Debian
sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine  # CentOS/RHEL

# 2. 安装依赖工具
sudo apt update && sudo apt install -y ca-certificates curl gnupg lsb-release  # Ubuntu/Debian
sudo yum install -y yum-utils device-mapper-persistent-data lvm2  # CentOS/RHEL

# 3. 添加Docker官方GPG密钥和仓库
# Ubuntu/Debian
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# CentOS/RHEL
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# 4. 安装Docker Engine
sudo apt update && sudo apt install -y docker-ce docker-ce-cli containerd.io  # Ubuntu/Debian
sudo yum install -y docker-ce docker-ce-cli containerd.io  # CentOS/RHEL

# 5. 启动Docker并设置开机自启
sudo systemctl enable --now docker

# 6. 验证安装
sudo docker run hello-world
```

## **2. 安装 Docker Compose（独立安装）**

```bash
# 下载最新版Docker Compose（替换版本号）
COMPOSE_VERSION=v2.36.2
sudo curl -L "https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# 赋予执行权限
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker-compose --version
```

------

# **三、关键使用示例**

## **1. Docker 单容器操作**

```bash
# 拉取镜像并运行容器
docker pull nginx
docker run -d -p 80:80 --name my-nginx nginx

# 查看运行中的容器
docker ps
```

## **2. Docker Compose 多服务编排**

创建 `docker-compose.yml` 文件：

```bash
version: '3'
services:
  web:
    image: nginx
    ports:
      - "80:80"
  db:
    image: mysql
    environment:
      MYSQL_ROOT_PASSWORD: my-secret-pw
```

启动服务栈：

```bash
docker-compose up -d  # 后台启动
docker-compose ps     # 查看服务状态
```

------

# **四、常见问题解决**

1. **权限问题**
   将当前用户加入 `docker` 组：

   ```bash
   sudo usermod -aG docker $USER
   newgrp docker  # 立即生效
   ```

2. **镜像加速**
   编辑 `/etc/docker/daemon.json`：

   ```bash
   {
     "registry-mirrors": ["https://registry.docker-cn.com", "https://hub-mirror.c.163.com"]
   }
   ```

   重启服务：

   ```bash
   sudo systemctl restart docker
   ```

3. **版本兼容性**
   Docker Compose v2+ 需要 Docker Engine 20.10+ 版本支持。