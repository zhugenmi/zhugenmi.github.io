---
title: k8s核心控制器与Pod管理模型
author: zhugenmi
date: 2025-5-21 9:00 +0800
categories: [Systematic Capacity,TOOLS]
tags: [k8s]
description: 
---

Kubernetes作为当今主流的容器编排系统，提供了多种控制器来管理Pod的生命周期和工作负载。这些控制器各司其职，共同构成了Kubernetes强大的编排能力。

## 基础概念

### 1. Pod：Kubernetes的最小部署单元

Pod是Kubernetes中最基本的调度和管理单元，代表集群中**运行的一个或多个容器**的组合。这些容器共享网络命名空间、存储卷和其他资源，作为一个整体被调度到同一节点上运行

关键特性：

- 临时性实体：Pod设计为短暂存在的，当Pod所在节点发生故障时，Pod会被重新调度到其他节点

- 单容器或多容器模式：通常每个Pod运行一个主容器，但也可以包含多个紧密耦合的辅助容器（如日志收集器）

- **共享资源**：同一Pod内的所有容器共享IP地址、端口空间和存储卷，可以通过localhost互相通信

示例Pod定义：

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
    ports:
    - containerPort: 80
```

### 2. ReplicaSet：确保指定数量的Pod副本运行

ReplicaSet是新一代的**副本控制器**，用于确保指定数量的相同Pod副本始终处于运行状态

核心功能：

- 副本维持：通过标签选择器监控Pod状态，自动创建或删除Pod以匹配期望的副本数
- 故障恢复：当Pod异常退出时，会自动创建新的Pod替代
- 扩缩容支持：可通过修改 `replicas` 字段或使用 `kubectl scale` 命令调整Pod数量

与ReplicationController的区别：

- ReplicaSet支持集合式的selector（matchExpressions），而ReplicationController只支持等式选择器
- 官方推荐使用ReplicaSet替代旧的ReplicationController

示例ReplicaSet定义：

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: frontend
spec:
  replicas: 3
  selector:
    matchLabels:
      tier: frontend
  template:
    metadata:
      labels:
        tier: frontend
    spec:
      containers:
      - name: php-redis
        image: gcr.io/google_samples/gb-frontend:v3
```

### 3. Deployment：声明式的Pod和ReplicaSet管理

Deployment为Pod和ReplicaSet提供了**声明式更新**能力，是管理无状态应用的首选控制器

主要特点：

- 滚动更新与回滚：支持渐进式更新Pod版本，并能快速回滚到历史版本
- ReplicaSet管理：实际上通过创建和管理ReplicaSet来实现Pod的副本控制
- 多策略更新：支持重建(Recreate)和滚动更新(RollingUpdate)两种策略

典型使用场景：

- 定义Deployment来创建Pod和ReplicaSet
- 滚动升级和回滚应用
- 扩容和缩容
- 暂停和继续Deployment

示例Deployment定义：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.7.9
        ports:
        - containerPort: 80
```

### 4. DaemonSet：确保每个节点运行特定Pod

DaemonSet确保全部（或部分）节点上运行一个**Pod副本**，适用于需要在每个节点上运行的系统级守护进程

核心特性：

- 节点级部署：当有新节点加入集群时自动部署Pod，节点移除时自动回收Pod
- 特定节点部署：可通过nodeSelector或亲和性规则限制Pod只在特定节点上运行
- 资源监控：默认具有"tolerations"，允许在资源受限节点上调度

典型应用场景：

- 运行集群存储daemon（如glusterd、ceph）
- 在每个节点上运行日志收集daemon（如fluentd、logstash）
- 在每个节点上运行监控daemon（如Prometheus Node Exporter）

示例DaemonSet定义：

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd
spec:
  selector:
    matchLabels:
      name: fluentd
  template:
    metadata:
      labels:
        name: fluentd
    spec:
      nodeSelector:
        log-collection-enabled: "true"
      containers:
      - name: fluentd-elasticsearch
        image: quay.io/fluentd_elasticsearch/fluentd:latest
```

### 5. StatefulSet：管理有状态应用

StatefulSet用于管理**有状态应用**，为Pod提供稳定的标识符和持久化存储

关键特性：

- 稳定的网络标识：Pod名称和主机名在重新调度后保持不变（形如 `<statefulset-name>-<ordinal-index>` ）
- 持久化存储：通过PersistentVolumeClaimTemplate为每个Pod提供独立的持久化存储
- 有序部署：按顺序创建、扩展和删除Pod（从0到N-1顺序）

应用场景：

- 数据库应用（如MySQL、MongoDB集群）
- 需要稳定网络标识和持久化存储的分布式系统（如ZooKeeper、Kafka）

示例StatefulSet定义：

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: web
spec:
  serviceName: "nginx"
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.7.9
        ports:
        - containerPort: 80
  volumeClaimTemplates:
  - metadata:
      name: www
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 1Gi
```

各控制器对比：

| 控制器类型  |   Pod副本管理    |      适用场景      |   存储特性   | 网络标识 |
| :---------: | :--------------: | :----------------: | :----------: | :------: |
| Deployment  | 维持指定数量副本 |     无状态应用     |   临时存储   |  不固定  |
| StatefulSet | 维持指定数量副本 |     有状态应用     |  持久化存储  |   稳定   |
|  DaemonSet  | 每个节点一个副本 |   节点级系统服务   | 可临时可持久 |  可固定  |
| ReplicaSet  | 维持指定数量副本 |   通常不直接使用   |   临时存储   |  不固定  |
|     Pod     |     单个实例     | 直接测试或特殊场景 |    可配置    |  不固定  |

Kubernetes通过多种控制器提供了不同层次的Pod管理能力，形成了一个完整而灵活的编排体系。理解Deployment、StatefulSet、DaemonSet、ReplicaSet和Pod各自的特点及相互关系，是设计高效可靠的Kubernetes应用架构的基础。根据应用的特性和需求选择合适的控制器，结合Kubernetes提供的丰富配置选项，可以构建出既灵活又稳定的容器化解决方案。